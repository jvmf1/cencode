#include "b64.h"
#include <stdio.h>

char b64chartable[] = {
	'A','B','C','D','E','F','G','H','I',
	'J','K','L','M','N','O','P','Q','R',
	'S','T','U','V','W','X','Y','Z','a',
	'b','c','d','e','f','g','h','i','j',
	'k','l','m','n','o','p','q','r','s',
	't','u','v','w','x','y','z','0','1',
	'2','3','4','5','6','7','8','9','+','/',
};

char b64bytetable[256] = {
	0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3e,0x0,0x0,0x0,0x3f,0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x3c,0x3d,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x0,0x0,0x0,0x0,0x0,0x0,0x1a,0x1b,0x1c,0x1d,0x1e,0x1f,0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
};

void b64_encode(unsigned char *data, size_t len, char *dest) {
	unsigned int t;
	unsigned char o0,o1,o2;
	unsigned char s0,s1,s2,s3;
	for (size_t i = 0; i < len;) {
		o0 = i < len? data[i++] : 0;
		o1 = i < len? data[i++] : 0;
		o2 = i < len? data[i++] : 0;
		t = (o2) | (o1 << 8) | (o0 << 16);
		s3 = o2 & 0b00111111;
		s2 = (o2 & 0b11000000) >> 6 | ((o1 & 0b00001111) << 2);
		s1 = (o1 & 0b11110000) >> 4 | (o0 & 0b00000011) << 4;
		s0 = (o0 & 0b11111100) >> 2;
		t = s3 | (s2 << 6) | (s1 << 12) | (s0 << 18);
		*dest++ = b64chartable[s0];
		*dest++ = b64chartable[s1];
		*dest++ = b64chartable[s2];
		*dest++ = b64chartable[s3];
	}
	dest--;
	for (size_t i = 0; i < ((len % 3) ? (3 - (len % 3)): 0); i++)
		*dest--='=';
}

void b64_decode(char *data, size_t len, unsigned char *dest) {
	char s0,s1,s2,s3;
	unsigned char o0,o1,o2;
	for (size_t i = 0; i < len;) {
		s0 = data[i] == '=' ? -1 : b64bytetable[data[i]];
		i++;
		s1 = data[i] == '=' ? -1 : b64bytetable[data[i]];
		i++;
		s2 = data[i] == '=' ? -1 : b64bytetable[data[i]];
		i++;
		s3 = data[i] == '=' ? -1 : b64bytetable[data[i]];
		i++;
		o2 = s3 | (s2 & 0b00000011) << 6;
		o1 = (s2 & 0b00111100) >> 2 | (s1 & 0b00001111) << 4;
		o0 = (s1 & 0b00110000) >> 4 | (s0 << 2);
		if (s1 != -1 && s0 != -1)
		*dest++ = o0;
		if (s2 != -1)
		*dest++ = o1;
		if (s3 != -1)
		*dest++ = o2;
	}
}
